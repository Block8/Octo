{@form}

<script>
    var blockContent = {@blockContent};

    if(!blockContent) {
        blockContent = {};
    }

    var galleryImagePicker = $('#block_gallery_parent_{@blockId}');
    var current = '';
    var imageList = $('<ul style="margin-top: 25px; list-style: none;padding-left:0px;"></ul>');

    var appendImage = function(id, data) {
        var item = $('<li style="display:block;position:relative;border:1px solid #ccc;padding:8px;margin-bottom:8px;"></li>').text(data).data('id', id);
        item.addClass(id);
        item.append('<input type="hidden" name="images[]" value="'+id+'">');

        var btn = $('<button class="close" style="position:absolute;right:8px;">').text('Ã—').on('click', function () {
            $(this).parent('li').remove();
        });

        item.append(btn);
        imageList.append(item);
    }

    $('.modal-footer button').attr('disabled', true);

    $.ajax({
        url: '/'+window.adminUri+'/media/metadata',
        data: {
            q: JSON.stringify(blockContent.images)
        },
        type:'POST',
        success:function(data) {
            var imagesMeta = JSON.parse(data);

            $.each(imagesMeta.results, function(i, item) {
                appendImage(imagesMeta.results[i].id, imagesMeta.results[i].text);
            });

            imageList.insertAfter(galleryImagePicker);
            galleryImagePicker.on('change', function () {
                appendImage($(this).val(), $(this).select2('data').text);
            });
        }
    });
</script>