<div class="row">
    <div class="col-lg-12">
        <div class="nav-tabs-custom">
            <div class="pull-right" style="margin-top: 5px; margin-right: 5px;">
                <div class="page-save-notice alert alert-success" style="float:left; margin: 0 5px 0 0; padding: 6px; display: none"></div>
                <a class="btn btn-success" href="/{@adminUri}/page/publish/{@page.id}">Publish Page</a>
            </div>

            <ul class="nav nav-tabs">
                <li class="active"><a href="#preview" data-toggle="tab"><i class="fa fa-search"></i> Page Preview</a></li>
                <li><a href="#details" data-toggle="tab"><i class="fa fa-info-circle"></i> Page Details</a></li>

                {if hasEditableBlocks}
                    {for blockGroups}
                        {if value.haseditable}
                            <li>
                                <a href="#tab_{@key}" data-toggle="tab">{@value.name}</a>
                            </li>
                        {/if}
                    {/for}
                {/if}
            </ul>

            <div class="tab-content">
                <div class="tab-pane active" id="preview">
                    <iframe id="page-preview" src="/page/preview/{@page.id}?version={@latest.id}" style="width: 100%; height: 450px; border: 0"></iframe>
                </div>

                <div class="tab-pane" id="details">
                    {@pageDetailsForm}
                </div>

                {if hasEditableBlocks}
                    {for blockGroups}
                        <div class="tab-pane" id="tab_{@key}">

                            {if value.haseditable}
                                {for value.blocks}
                                    <div class="row block-editor">
                                        <div class="col-lg-2"><h4>{@value.name}</h4></div>
                                        <div class="col-lg-10">{@value.editor}</div>
                                    </div>
                                {/for}
                            {/if}

                        </div>

                    {/for}
                {/if}

            </div>
        </div>
    </div>
</div>

<script>
    $(document).ready(function ()
    {
        PageLock.setup();

        var editor = new window.pageEditor();
        editor.id = '{@page.id}';
        editor.content_id = '{@latest.content_item_id}';
        editor.content = {@pageContent};
        editor.page = {
            title: '{@latest.title}',
            short_title: '{@latest.short_title}',
            description: '{@latest.description}',
            meta_description: '{@latest.meta_description}',
            template: '{@latest.template}',
            image_id: '{@latest.image_id}',
            parent_id: '{@page.parent_id}'
        };
        editor.templates = {@templates};
        editor.pages = {@pages};

        $('.block-editor footer').hide();

        CKEDITOR.on('instanceReady', function (instance) {
            instance.editor.on('blur', function () {
                var element = $(instance.editor.element.$);
                editor.triggerSaveContent(element.parents('form'));
            });
        });

        $('.block-editor input:not(.skip-autosave, .select2-input)').on('change', function () {
            editor.triggerSaveContent($(this).parents('form'));
        });

        $('.block-editor input').on('autosave', function () {
            editor.triggerSaveContent($(this).parents('form'));
        });

        $('.block-editor select:not(.skip-autosave)').on('change', function () {
            editor.triggerSaveContent($(this).parents('form'));
        });

        $('#details input:not(.skip-autosave, .select2-input)').on('change', function () {
            editor.triggerSaveDetails();
        });

        $('#details input').on('autosave', function () {
            editor.triggerSaveDetails();
        });

        $('#details select:not(.skip-autosave)').on('change', function () {
            editor.triggerSaveDetails();
        });
    });



    var PageLock = {
        pingTimer: null,
        activityTimer: null,

        setup: function () {
            $(window).on('keypress', PageLock.onActivity);
            $(window).on('mousemove', PageLock.onActivity);

            $('div.well').on('mousemove', PageLock.onActivity);

            PageLock.pingTimer = setInterval(PageLock.ping, 5000);
            PageLock.activityTimer = setTimeout(PageLock.onInactiveTimeout, 60000 * 15);
        },

        ping: function () {
            $.get('/{@adminUri}/page/edit-ping/{@page.id}');
        },

        onActivity: function () {
            if (PageLock.activityTimer) {
                clearTimeout(PageLock.activityTimer);
            }

            if (PageLock.unlockTimer) {
                clearTimeout(PageLock.unlockTimer);
            }

            PageLock.activityTimer = setTimeout(PageLock.onInactiveTimeout, 60000 * 15);
        },

        onInactiveTimeout: function () {
            window.location.href = '/{@adminUri}/page';
        }
    }

</script>
