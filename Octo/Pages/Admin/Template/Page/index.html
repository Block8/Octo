<div class="row">

    <div class="col-lg-4">
        <div class="box box-primary">
            <div class="box-body">
                <ul class="pageview">
                    {include template: "Page/list"; variables: pages}
                </ul>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="box box-success box-page-options" style="display: none">
            <div class="box-header">
                <h3 class="box-title"></h3>
            </div>

            <div class="box-body page-options">
                <div class="alert alert-warning fade in">
                    <i class="fa fa-info"></i>
                    <span>This page is currently locked for editing by Dan Cryer</span>
                </div>

                <a class="btn-edit btn btn-block btn-default"><i class="fa fa-pencil"></i> <span>Edit Page</span></a>
                <a class="btn-duplicate btn btn-block btn-default"><i class="fa fa-copy"></i> <span>Duplicate Page</span></a>
                <a class="btn-create btn btn-block btn-default"><i class="fa fa-plus-circle"></i> <span>Create Child Page</span></a>
                <a class="btn-delete btn btn-block btn-default"><i class="fa fa-trash"></i> <span>Delete Page</span></a>
            </div>
        </div>

    </div>

<script>

    $(document).ready(function () {
        registerEvents();
        loadChildren($('.pageview li'));
    });

    function registerEvents()
    {
        $('.open-arrow').on('click', function (e) {
            e.stopPropagation();

            if ($(this).hasClass('fa-caret-right')) {
                var parent = $(this).parent();
                loadChildren(parent)
            } else {
                $(this).removeClass('fa-caret-down').addClass('fa-caret-right');
                $(this).parent().find('ul').slideUp('fast', function () { $(this).remove(); });
            }
        });

        $('.pageview li').off('click');
        $('.pageview li').on('click', function (e) {
            e.stopPropagation();

            var page = $(this);
            var options = $('.box-page-options');
            options.hide();

            if (page.data('locked')) {
                options.find('.btn').hide();
                options.find('.alert').show();
            } else {
                options.find('.btn').show();
                options.find('.alert').hide();
            }

            var title = $(this).text();

            options.find('.box-title').text(title);
            options.find('.btn-edit').attr('href', '/{@adminUri}/page/edit/' + page.data('id')).find('span').text('Edit ' + title);
            options.find('.btn-create').attr('href', '/{@adminUri}/page/add/' + page.data('id')).find('span').text('Create Child Page');
            options.find('.btn-delete').attr('href', '/{@adminUri}/page/delete/' + page.data('id')).find('span').text('Delete ' + title);
            options.find('.btn-duplicate').attr('href', '/{@adminUri}/page/duplicate/' + page.data('id')).find('span').text('Duplicate ' + title);

            options.fadeIn();
        });

        var fixHelper = function(e, ui) {
            ui.children().each(function() {
                $(this).width($(this).width());
            });
            return ui;
        };

        $('.pageview').find('ul').each(function () {
            var pageList = $(this);

            pageList.sortable({
                axis: 'y',
                containment: 'parent',
                items: 'li',
                helper: fixHelper,
                update: function () {
                    var position = 0;
                    var items = {};

                    pageList.find('> li').each(function () {
                        var id = $(this).data('id');
                        items[id] = position++;
                    });

                    savePositions(items);
                }
            });
        });
    }

    function loadChildren(parent)
    {
        var parentId = parent.data('id');
        parent.find('.open-arrow').removeClass('fa-caret-right').addClass('fa-caret-down');

        var childList = $('<ul></ul>').hide();
        parent.append(childList);

        $.get('/{@adminUri}/page?parent=' + parentId, function (data) {
            childList.append(data);
            childList.slideDown('fast');

            $('.open-arrow').off('click');
            registerEvents();
        });
    }

    function savePositions(items)
    {
        $('.pace').removeClass('hide');

        $.post('/' + window.adminUri + '/page/sort', {positions: items}, function () {
            $('.pace').addClass('hide');
        });
    }


</script>
