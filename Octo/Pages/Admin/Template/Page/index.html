<table class="table table-bordered table-striped pages-list">
    <thead>
    <tr>
        <th>Title</th>
        <th>Link</th>
        <th>Last Editor</th>
        <th>Last Update</th>
        <th></th>
        <th width="100px">Actions</th>
    </tr>
    </thead>
    <tbody>
    {for pages}
    <tr{if item.parent_id} class="sub-page"{/if} data-id="{@item.id}">
        <td>{if item.id != parentId}<i class="fa fa-chevron-right"></i> {/if}
            {if item.hasChildren}{if item.id != parentId}<a href="/{@adminUri}/page?parent={@item.id}">{/if}{/if}
            {@item.CurrentVersion.title}
            {if item.hasChildren}{if item.id != parentId}</a>{/if}{/if}

            {if item.isLocked}<br><span class="label label-warning"><i class="fa fa-lock"></i> Locked for editing by {@item.latestVersion.User.name}</span>{/if}

        </td>
        <td><a href="{@item.uri}">{@item.uri}</a></td>
        <td>
            {if item.latestVersion.User}{@item.latestVersion.User.name}{/if}
        </td>
        <td>{date_format date: item.latestVersion.updated_date}</td>
        <td width="2%">
            {if item.parent_id}
            <i class="fa fa-fw fa-move handler"></i>
            {/if}
        </td>
        <td>
            {ifnot item.isLocked}
            <div class="btn-group">
                {if (can_access uri: "/page/edit")}
                <a class="btn btn-default btn-sm" href="/{@adminUri}/page/edit/{@item.id}">Edit</a>
                {/if}

                {if (can_access uri: "/page/delete")}
                <a class="btn btn-default btn-sm dropdown-toggle" data-toggle="dropdown" href="javascript:void(0);"><span class="caret"></span></a>
                <ul class="dropdown-menu">
                    <li>
                        <a href="/{@adminUri}/page/delete/{@item.id}" class="btn-delete">Delete</a>
                    </li>
                </ul>
                {/if}
            </div>
            {/ifnot}
        </td>
    </tr>
    {/for}
    </tbody>
</table>

<script>
    var fixHelper = function(e, ui) {
        ui.children().each(function() {
            $(this).width($(this).width());
        });
        return ui;
    };

    $('.pages-list tbody').sortable({
        handle: '.handler',
        axis: 'y',
        items: '> tr.sub-page',
        helper: fixHelper,
        update: function () {
            var position = 0;
            var items = {};

            $('tr.sub-page').each(function () {
                var id = $(this).data('id');
                items[id] = position++;
            });

            savePositions(items);
        }
    });

    function savePositions(items)
    {
        $('.pace').removeClass('hide');

        $.post('/' + window.adminUri + '/page/sort', {positions: items}, function () {
            $('.pace').addClass('hide');
        });
    }


</script>